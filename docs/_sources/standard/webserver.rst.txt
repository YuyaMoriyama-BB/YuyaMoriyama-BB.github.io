2.2. Webサーバを公開する(NAT,NAPT)
====================================

WCIルータとファイアウォール/ルータ等のセキュリティアプライアンスを接続し、NATおよびNAPTを利用してWCIアドレスを拠点内のWebサーバ（443/tcp）に変換することで、拠点内のサーバをWCIネットワーク（IPv4）上に公開します。同時に、外部公開を行わない閲覧用の拠点ネットワークを作成します。


1. 接続構成とネットワーク
--------------------------

**接続構成図** 

.. image:: ./images/webserver.png
   :scale: 30%

.. attention::
   | ※1,2　導入機種により接続ポートが異なります。詳しくは" :doc:`../preface/init` "の導入機種に応じたポート対応表をご確認下さい。
   | ※3  　ご契約拠点により、WCIアドレスおよびサブネットの割当範囲が異なります。別途ご確認下さい。本資料ではWCIアドレス割当範囲を ``100.65.21.0/26``、WCIルータのLANポートアドレスを ``100.65.21.1`` として記載します。


----

- **拠点ネットワークA** 

|   　本事例ではこのネットワークのみを外部に公開対象とし、Webサービスやアプリケーションの提供を行います。  

- **拠点ネットワークB**  
  
|   　外部公開は行わず、WCI Portalや他拠点サービスへのアクセス用途に限定します。  

----

2. セキュリティアプライアンスについて
-----------------------------------------

| 基本的なNAT,NAPT機能を有する多くの機種で問題なくご利用いただける見込みです。
|
| 本事例では、Fortinet社のFortiGate(FortiOS 7.2, 7.4)を一例として設定方法を紹介します。


----


3. WCIポータルの設定
-----------------------

| `WCI Portal <https://portal.bbwci.net>`_ (`https://portal.bbwci.net`)にアクセスしログインします。
| 必要に応じて、WCIルータのLANポートに設定用端末を接続してアクセスして下さい。

サブネットの登録
^^^^^^^^^^^^^^^^^^

.. image:: ./images/screen/1.png
   :scale: 70%

**[サブネット管理]** より、IPv4アドレス欄の **[登録]** ボタンを押下します。

----

.. image:: ./images/screen/2.png
   :scale: 60%

- **[サブネット名]** に名称を設定します。 ``sample_single_subnet``

- **[プレフィックス]** を指定します。プレフィックスは任意のサイズを割り当てることが可能ですが本事例では ``/26`` を設定します。

- **[ネットワークアドレス]** を指定します。``100.65.21.0`` を設定します。

- **[登録]** ボタンを押下します。

----

.. image:: ./images/screen/3.png
   :scale: 70%

画面に先ほど設定したサブネットが登録されている事を確認します。
このサブネットが拠点ネットワークAのアドレス帯となります。


----

接続
^^^^^

| 他拠点との接続については別紙 `WCI-Portal 利用手順書` をご確認ください。
| 接続で指定するサブネットは本事項で作成したものを指定してください。

----

フィルタ管理
^^^^^^^^^^^^^^

.. image:: ./images/screen/4.png
   :scale: 60%


画面の **[新規]** ボタンを押下します。

----

.. image:: ./images/screen/5.png
   :scale: 60%

フィルタ登録画面にて、**[サブネットID]** を押下します。

.. image:: ./images/screen/6.png
   :scale: 60%


サブネット選択画面にて先ほど登録した **サブネット**  ``100.65.21.0/26`` の行の **[選択]** を押下します。

----

.. image:: ./images/screen/7.png
   :scale: 60%


フィルタ登録画面にて、サブネットが選択されたことを確認します。

----

- 続いて、フィルタリング (インバウンド)にて **[追加]** ボタンを押下します。

- **[プロトコル]** : ``TCP`` , **[ポート]** : ``443`` と設定します。

- **[登録]** ボタンを押下します。

----




4. セキュリティアプライアンスの設定例
----------------------------------------

| NAT（ネットワークアドレス変換）とNAPT（ネットワークアドレスポート変換）機能を使用して、
| WCIアドレス(IPv4)を拠点ネットワーク内の端末のアドレスへ変換する事で通信を実現します。

**物理インターフェース構成** 

.. image:: ./images/screen/fw.png
   :scale: 30%

----

アドレス設定
^^^^^^^^^^^^^
WCIアドレスは以下の様に定義されています。

- 100.64.0.0 ～ 100.127.255.255 (100.64.0.0/10)

FortiGateのGUIダッシュボード画面より **[アドレス]** → **[新規作成]** からアドレスを以下の様に編集します。

.. image:: ./images/screen/8.png
   :scale: 70%

.. csv-table::
   
   " **項目名** "," **項目内容** "
   " **IP/ネットマスク** ", "100.64.0.0 255.192.0.0"

----

スタティックルート設定
^^^^^^^^^^^^^^^^^^^^^^^^^^

**[スタティックルート]** → **[新規作成]** から新規スタティックルートを以下の様に編集します。

.. image:: ./images/screen/9.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **宛先(サブネット)** ", "100.64.0.0 255.192.0.0"
   " **ゲートウェイアドレス** ", "100.65.21.1"
   " **インタフェース** ", "wan1"

----

DNS設定
^^^^^^^^

**[DNS]** からDNS設定を以下の様に編集します。

.. image:: ./images/screen/10.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **DNSサーバ** ", "指定"
   " **プライマリDNSサーバ** ", "100.65.21.1"
   " **DNSプロトコル** ", "DNS(UDP/53)"

----

WAN設定
^^^^^^^^

| **[インタフェース]** から任意のインターフェースを選択して編集を行います。
| 本事例では物理インターフェース ``wan1`` にWCIルータを接続する構成とするため、 ``wan1`` を選択します。

.. image:: ./images/screen/11.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **アドレッシングモード** ", "マニュアル"
   " **IP/ネットマスク** ", "100.65.21.2/255.255.255.192"

----

LAN設定(拠点ネットワークA)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

| **[インタフェース]** から任意のインターフェースを選択して編集を行います。
| 本事例では物理インターフェース ``internal1`` 配下に拠点ネットワークAを構成するため、 ``internal1`` を選択します。

.. image:: ./images/screen/12.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **アドレッシングモード** ", "マニュアル"
   " **IP/ネットマスク** ", "10.0.10.1/255.255.255.0"

----

NAT設定(拠点ネットワークA)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

| **[バーチャルIP]** → **[新規作成]** から仮想IPを以下の様に編集します。

.. image:: ./images/screen/13.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **インターフェース** ", "wan1"
   " **タイプ** ", "スタティックNAT"
   " **外部IPアドレス/範囲** ", "100.65.21.3"
   " **IPv4アドレス/範囲** ", "10.0.10.10"

- **ポートフォワード** を有効化します。

.. csv-table::

   " **項目名** "," **項目内容** "
   " **プロトコル** ", "TCP"
   " **ポートマッピングタイプ** ", "1対1"
   " **外部サービスポート** ", "443"
   " **IPv4ポートへマップ** ", "443"

-----

| 続いて、 **[IPプール]** → **[新規作成]** からダイナミックIPプールを以下の様に編集します。

.. image:: ./images/screen/14.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **タイプ** ", "オーバーロード"
   " **外部IP範囲** ", "100.65.21.3-100.65.32.3"

ポリシー設定(拠点ネットワークA)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

| **[ファイアウォールポリシー]** → **[新規作成]** から以下の様にポリシーを作成します。

.. image:: ./images/screen/15.png
   :scale: 80%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **着信インターフェース** ", "wan1"
   " **発信インターフェース** ", "internal1"
   " **送信元** ", "WCI(アドレス設定で作成したもの)"
   " **宛先** ", "VIP_WebServer(NAT設定-バーチャルIPで作成した物)"
   " **サービス** ", "HTTPS"

- **NAT** を有効化します。

.. csv-table::


   " **IPプール設定** ", "ダイナミックIPプールを使う","WebServer(NAT設定-IPプールで作成した物)"


- 適切なセキュリティプロファイルを設定します

----

| これで、接続している他拠点に対して、Webサーバを公開する設定が完了しました。
| 続いて、拠点ネットワークBの設定を行います。

.. tip::
   | 本事例では ``443/tcp`` を許可する設定ですが許可するプロトコル・ポートを変更することで任意のサービスを公開することが可能です。

----

LAN設定(拠点ネットワークB)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

| **[インタフェース]** から任意のインターフェースを選択して編集を行います。
| 本事例では物理インターフェース ``internal2`` 配下に拠点ネットワークBを構成するため、 ``internal2`` を選択します。

.. image:: ./images/screen/16.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **アドレッシングモード** ", "マニュアル"
   " **IP/ネットマスク** ", "172.16.10.1/255.255.255.0"

DNSサービス設定(拠点ネットワークB)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

| 拠点ネットワークBに対して、DNSプロキシの設定を行います。
| 拠点ネットワークBの端末において ``internal2`` のアドレスをDNSサーバとして設定する事でDNSの通信をWCIルータに転送できます。
|
| **[DNSサーバ]** → **インターフェース上のDNSサービス** → **[新規作成]** からDNSサービスを以下の様に編集します。

.. image:: ./images/screen/17.png
   :scale: 70%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **インターフェース** ", "internal2"
   " **モード** ", "システム設定DNSへ転送"

※ 拠点ネットワークAでも、DNSサーバをinternal1のアドレスとする時は同様にinternal1のDNSサービスを作成してください。


ポリシー設定(拠点ネットワークB)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

| **[ファイアウォールポリシー]** → **[新規作成]** から以下の様にポリシーを作成します。

.. image:: ./images/screen/18.png
   :scale: 80%

.. csv-table::

   " **項目名** "," **項目内容** "
   " **着信インターフェース** ", "internal2"
   " **発信インターフェース** ", "wan1"
   " **送信元** ", "all"
   " **宛先** ", "WCI(アドレス設定で作成したもの)"
   " **サービス** ", "ALL"

※ **送信元** , **サービス** は利用用途に応じて適切に設定してください。

- **NAT** を有効化します。

.. csv-table::

   " **項目名** "," **項目内容** "
   " **IPプール設定** ", "発信インタフェースアドレスを使用"

- 適切なセキュリティプロファイルを設定します。

----

これで、拠点ネットワークBからWCI Portalや他接続拠点で公開されているサービスへのアクセスが可能となります。端末からの通信はNAPTにて、ファイアウォールのアドレス ``100.65.21.2`` に変換されます。


